let ws,rt,u;const e=q=>[{className:'status '+q,textContent:q[0].toUpperCase()+q.slice(1)}][0],s=document.getElementById('status'),p=document.getElementById('playersList'),n=document.getElementById('userName'),a=document.getElementById('userAvatar'),nf=document.getElementById('notifications'),adj=['Swift','Clever','Bold','Cunning','Mighty','Sharp','Quick','Brave','Wise','Fearless'],ani=['Rook','Knight','Bishop','Queen','Pawn','Eagle','Tiger','Lion','Fox','Wolf'];function g(){return adj[Math.random()*adj.length|0]+' '+ani[Math.random()*ani.length|0]}function h(t){let c=0;for(let i=0;i<t.length;i++)c=((c<<5)-c)+t.charCodeAt(i),c|=0;return Math.abs(c)}function d(t){return`https://api.dicebear.com/7.x/adventurer/svg?seed=${encodeURIComponent(t)}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50`}async function l(t,c){try{let r=await fetch(d(c),{mode:'cors',headers:{'Accept':'image/svg+xml'}});if(!r.ok)throw 0;t.src=URL.createObjectURL(await r.blob())}catch(i){let v=document.createElement('canvas');v.width=v.height=64;let m=v.getContext('2d'),b=h(c)%360,x=60+(b%20),y=c.split(/\s+/).filter(Boolean);m.fillStyle=`hsl(${b} ${x}% 50%)`,m.beginPath(),m.arc(32,32,32,0,6.28),m.fill(),m.fillStyle='rgba(255,255,255,.92)',m.font='bold 26px system-ui',m.textAlign='center',m.textBaseline='middle',m.fillText(y.slice(0,2).map(f=>f[0]).join(''),32,32),t.src=v.toDataURL()}}function w(){n.textContent=u,a.alt=u,l(a,u),s.className=e('connected').className}function iv(r){ws.send(JSON.stringify({type:'MATCH_INVITE',data:{to:r}}))}function ni(f){let nd=document.createElement('div');nd.className='notification';let nt=document.createElement('div');nt.className='notification-text';nt.textContent=`${f} invited you to play`;let nb=document.createElement('div');nb.className='notification-timer';let np=document.createElement('div');np.className='notification-progress';nb.appendChild(np);nd.appendChild(nt);nd.appendChild(nb);nf.appendChild(nd);let st=Date.now(),du=30000;let ti=setInterval(()=>{let el=Date.now()-st,pr=(du-el)/du*100;if(pr<=0){clearInterval(ti);nd.classList.add('fade-out');setTimeout(()=>nd.remove(),300)}else{np.style.width=pr+'%'}},50)}function z(){s.className=e('connecting').className,ws=new WebSocket(`${location.protocol==='https:'?'wss:':'ws:'}//${location.host}/ws/lobby`),ws.onopen=()=>{s.className=e('connected').className,rt&&(clearTimeout(rt),rt=null)},ws.onmessage=t=>{try{let c=JSON.parse(t.data);if(c.type==='PLAYER_LIST'){p.innerHTML='';c.players.forEach(r=>{let o=document.createElement('div');o.className='player-item';let f=document.createElement('img');f.className='player-avatar',f.alt=r,f.src='data:image/svg+xml,%3Csvg%3E%3C/svg%3E',l(f,r);let j=document.createElement('div');j.className='player-name',j.textContent=r;o.appendChild(f);o.appendChild(j);if(r!==u){let ib=document.createElement('button');ib.className='invite-btn';ib.textContent='Invite';ib.onclick=()=>iv(r);o.appendChild(ib)}p.appendChild(o)})}else if(c.type==='MATCH_INVITE'){ni(c.data.from)}}catch(c){}},ws.onclose=()=>{s.className=e('disconnected').className,ws=null,rt=setTimeout(z,3e3)}}
async function au(){try{await fetch('/join?username='+encodeURIComponent(u));u=u}catch(e){}}window.addEventListener('load',async()=>{u=g(),w(),await au(),z()});
